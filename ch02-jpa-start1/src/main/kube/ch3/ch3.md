## 쿠버 3장 파드: 쿠버네티스에서 컨테이너 실행
3.1 파드 소개
- 파드는 컨테이너 그룹이며 쿠버네티스의 기본 빌딩 블록이다.
- 항상 파드가 두개이상의 컨테이너를 포함하는 것은 아니다.
- 일반적으론 하나의 파드엔 하나의 컨테이너
- 항상 하나의 워커노드에서 실행되며 여러노드의 워커노드에 겹쳐실행되지않음

3.1.1 파드가 필요한 이유
- 여러 프로세스가 있는 단일컨테이너보다 다중 컨테이너가 나은이유
- 컨테이너는 단일 프로세스를 실행하는 것을 목적으로 설계했다.(프로세스가 자기 자신의 자식 프로세스를 생성하는것 예외)
- 단일컨테이너에서 다른프로세스를 실행하는경우, 모든 프로세스와 로그관리는 모두 사용자 책임
- 개별프로세스가 실패하는경우 자동 재시작 매커니즘 포함
- 표준 출력으로 로그를 기록해서 어떤 프로세스의 로그인지 파악 매우 어려움
- 그래서 각 프로세스를 자체의 개별 컨테이너로 실행해야한다. 이것이 도커와 쿠버의 사용법이다

3.1.2 파드 이해하기
 - 여러 프로세스를 단일 컨테이너로 묶지 않기때문에, 컨테이너를 묶고 하나의 단위로 관리하는 상위구조필요
 - 이게 파드의 존재이유이다.
 - 연관된 프로세스를 함께 실행하고 단일 컨테이너 안에서 모두 함께 실행되는 것처럼, 거의 동일한 환경을 제공하면서도, 이들을 격리된 상태로 유지할 수 있다.
 - 컨테이너가 제공하는 모든기능 활용 동시, 프로세스가 함께 실행 되는 것처럼 보이게 할 수 있다.

 #### 같은 파드에서 컨테이너간 부분격리
 - 2장에서 컨테이너가 완벽 분리됨 배움,
 - 이젠 개별컨테이너가 아닌 컨테이너 그룹을 분리 함.
 - 그룹안에 컨테이너가 리소스를 공유하기위해 컨테이너가 완벽하게 격리되지 않도록 한다.
 - 쿠버는 파드안에 있는 모든 컨테이너가 자체네임스페이스가 아닌 동일한 네임스페이스를 공유하도록 도커설정.
 
 #### 컨테이너가 동일한 IP와 포트공간을 공유하는 방법
 - 강조할 한가지는 각 파드안의 컨테이너가 동일한 네트워크 네임스페이스에서 실행
 - 동일한 Ip주소와 포트를 공유
 - 즉 파드안 컨테이너가 동일한포트번호를 사용하지않도록 주의
 - 파드안에 있는 모든컨테이너는 동일한 루프백 네트워크 인터페이스를 갖기때문에 로컬호스트를 통해 컨테이너끼리 통신가능

 #### 파드간 네트워크 플랫 소개
 - 모든 파드는 하나의 플랫한 공유 네트워크 주소공간에 상주함.
 - IP주소를 통해 파드끼리 접근하는 것이 가능 (NAT가 존재하지않음)
 - 마치 근거리 컴퓨터 통신과 비슷(LAN)
 - 요약하자면 파드는 논리적인 호스트로서, 컨테이너가 아닌 환경에서의 물리적 호스트 혹은 VM과 흡사하게 동작
 - 동일한 파드에서 실행한 프로세스는 각 프로세스가 컨테이너 안에 캡슐화 돼 있다는점을 빼면, 같은 물리적 혹은 가상머신에서 동작하는 것과 동일

3.1.3 파드에서 컨테이너의 적절한 구성
 - 파드는 특정한 애플리케이션만을 호스팅 한다.
 - 한 호스트에 모든 유형의 애플리케이션을 넣었던 것과 달리, 파드는 그렇게 사용X
 - 파드는 상대적으로 가볍기 때문에 오버헤드 없이 필요한 만큼 파드 갖기 가능
 
#### 다계층 애플리케이션을 여러 파드로 분할
 - 프론트엔드 백엔드가 같은 파드에 있따면? 둘은 항상같은노드에서 실행됨
 - 두노드를 가진 쿠버클러가 있고, 이 파드 하나만 있다면, 워커노드 하나만 사용하고 두번째 노드에서 이용할수있는 리소스(CPU, 메모리등)를 활용안하고 버리게됨
 - 파드를 두개로 분리 뒤 백엔드, 프론트 각각 노드를 스케줄링해 인프라 활용도 상승가능

#### 개별 확장이 가능하도록 여러파드로 분할
 - 두컨테이너를 하나의 파드에 넣지말아야 하는 또 다른이유는 스케일링 이다.
 - 기본 스케일 단위는 파드이다.
 - 쿠버는 개별 컨테이너를 수평확장 불가능
 - 만약 백+프론트 구성파드를 스케일링 하면 2개의 백+플런트 컨테이너 갖게됨
 - DB같은경우 프론트 웹 서버에비해 확장 어려움, 컨테이너 개별적 스케일링 필요시 별도 파드 배포

#### 파드에서 여러컨테이너 사용경우
 - 주요 애플레이션을 여러 보완프로세스가 있는경우 그런식으로 구성한다.
 - 로그수집기, 데이터프로세서, 통신어댑터 등이있다.

#### 파드에서 여러컨테테이너를 사용 하는 경우 결정
 - 단일 파드 vs 여러파드 질문해보자
 - 컨테이너를 함께 실행해야하는가? 다른호스트 가능한가
 - 여러컨테이너가 모여 하나의구성요소? 아님 개별
 - 컨터이너가 함께 스케일링 되어야하는가?


3.2 yaml 또는 json 디스크립터로 파드 생성
(시작시 “did you specify the right host or port” 오류로 안됏을때 도커부터 실행할것)
```
## 노드 2개만듬 mulinode 접두사로
minikube start --nodes 2 -p multinode 
```
— 3.3 레이블을 이용한 파드 구성.
이제 파드 두개가 클러스터에서 실행되고 있다. 레이블을 통해 파드와 기타 다른 쿠버네티스의 오브젝트의 조직화가 이뤄진다.
— 3.3.1 레이블
레이블은 리소스에 첨부하는 키-값 쌍으로, 레이블 셀렉터를 사용해 리소스를 선택할 때 활용된다. 레이블은 리소스내에서 고유하다.

— 3.3.2 라벨표시
```
 kubectl get po --show-labels
 kubectl get po -L creation_method,env
```
— 3.3.3 기존 파드 레이블 수정

```
kubectl label po kubia-manual creation_method=manual
## 기존 레이블을 변경시에는 오버라잇옵션필요
kubectl label po kubia-manual-v2 env=debug --overwrite
```

— 3.4 레이블 셀렉터를 이용한 파드 부분집합 나열
```
kubectl get po -l creation_method=manual
##env 레이블은 가지고 있으나 무엇이든 다볼땐
kubectl get po -l env
## env 안가지고 있는것 볼땐
kubectl get po -l '!env'
## 레이블 가지고있으나 매뉴얼이 아닌것
kubectl get po -l creation_method!=manual
```

— 3.4.2 레이블 셀렉터에서 여러조건 사용
```
##app이 pc이면서 라벨 베타
app=pc,rel=beta

```

— 3.5 레이블과 셀럭터를 이용해 파드 스케줄링 제한
- 지금까지는 워커노드 전체에 무작위로 스케줄링
- 이건 쿠버네티스에서 적절함, 모든노드를 하나의 대규모 플랫폼으로 노출, 스케줄링은 중요x
- 그러나 파드 스케줄링 위치가 약간 영향인 경우있음.  가령 일부는 HDD 나머지 SDD 특정파드를 한구룹에 나머지를 다른구룹에 또는 GPU 가속을 제공하는 노드에만 계산이필요한 파드를 배정 등

— 3.5.1 워커노드 분류에 레이블사용
- 앞서 말한것처럼 파드만이 유일한 레이블 부착가능한 쿠버 리소스아님
- 노드 포함 모든 리소스에 레이블 부착가능.
- 클라우드에 GPU를 가지고 있는 노드가 있다고 가정, gpu=true 레이블추가
```
kubectl label node minikube gpu=true
##조회 
kubectl get nodes -l gpu=true
##gpu 속성 show
kubectl get nodes -L gpu 
```

— 3.5.3
- 그러나 지정한 node가 오프라인 상태인경우 파드가 스케줄링 되지 않을 수 있다.

— 3.6 파드에 어노테이션 달기
- 파드 및 다른오브젝트는 라벨 말고도 어노태이션을 가질 수 있다.
- 레이블은 오브젝트를 묶을수 있지만, 어노테이션은 그럴 수 없다.
- 어노테이션은 더 많은 정보를 보유 할 수 있다.
- 어노테이션이 유용한 경우는 파드나 다른 API오브젝트에 설명을 추가해 두는것이다.
- 오브젝트를 만든 사람 이름을 어노테이션으로 지정해 두면 클러스터 작업시 좀더 쉽게 협업가능

— 3.6.1
Annotation 조회
```
kubectl get po kubia-manual -o yaml
## Kubernetes.io/create-by 어노테이션이 보일것이다. 비교적 라벨보다 큰정보 포함가능 256kb까지
```

— 3.6.2 파드에 어노테이션 추가
```
kubectl annotate pod kubia-manual mycompany.com/someannoation="foo bar"
##조회
kubectl describe pod kubia-manual
```

— 3.7 네임스페이스를 사용한 리소스 그룹화
- 레이블을 이용해 파드와 다른오브젝트를 그룹으로 묶었다.
- 오브젝트 그룹은 서로 겹칠 수 있다.
- 오브젝트를 겹치지않는 그룹으로 분할 하고 자 할때는 어떻게 해야할까?
- 프로세스를 격리하는 리눅스 네임스페이스가 아님
- 오브젝트의 이름의 범위를 제공함
- 모든 리소스를 하나의 단일 네임스페이스에 두는 대신에 여러 네임스페이스로 분할가능
- 네임스페이스는 같은 리소스의 이름을 다른 네임스페이스에 걸쳐 여러번 사용 가능

— 3.7.
-  리소스를 프로덕션,개발,QA환경으로 나누어 사용 할 수 있다.
-  서로다른 두 네임스페이스는 동일한 이름의 리소스를 가질 수 있다.
- 리소스 이름은 네임스페이스 안에서만 고유함.

— 3.7.2. 다른 네임스페이스와 파드 보기
```
kubectl get ns
## namespaceeotls -n 가능
kubectl get po --namespace kube-system
```
- 지금까진 default 네임스페이스에서만 작업진행함.

3.7.3 네임스페이스 생성
```
kubectl create -f custom-namespace.yaml
```
3.7.4 다른 네임스페이스의 오브젝트 관리
 —n항목을 넣거나 kubectl create를 할때 네임스페이스를 지정한다.
```
kubectl create -f kubia-manual.yaml -n custom-namespace
```
 — 동일한 이름을 가진 파드가 default 네임스페이스와 custom-namespace안에 있다.
 — 다른네임스페이스 오브젝트를 나열하거나 수정,삭제할때는 -n을 추가해야한다.
 - 네임스페이스를 ㅣ쩡하지않으면 현재 컨텍스트에 있는 기본네임스페이스에서 작업을 수행한다.
 - 현재 컨텍스트와 네임스페이스는 kubectl config 명령으로 변경 가능하다.
```
## kcd some=namepsace명령으로 네임스페이스 전환가능
alias kcd='kubectl config set-context $(kubectl config current-context) --namespace '
```

3.7.5 네임스페이스 격리 이해
- - 실행중인 오브젝트에 대한 격리는 제공 안함.
- - 예를들어 다른 사용자들이 서로 다른 네임스페이스에 파드를 배포 할 때 해당파드가 서로 격리돼 통신할 수없다고 생각하지만 그건 아니다.
- - 쿠버네티스와 함께 배포되는 네트워킹 솔루션에 따라 다르다
- - 네트워크 솔루션이 네임스페이스간 격리를 제공하지 않는경우 네임스페이스간 IP주소를 알고있었다면, HTTP 요청과 같은 트래픽을 다른 파드로 보낼수 있음

3.8 파드의 중지와 제거
레이블 셀렉터를 이용해 파드를 다 삭제할 수도 있다.
```
#네임스페이스 전체삭제
Kubectl delete ns custom-namespace
#네임스페이스 유지하면서 파드 모두삭제
Kubectl delete po -all
Kubectl delete all —all
```