1. emptyDir 볼륨을 사용하여 fortune pod 생성해보고 curl 요청보내어 응답받아보기.
2. 볼륨을 사용하는 파드를 생성하고, 파드 내 MongoDB 데이터베이스에 도큐먼트를 추가해 퍼시스턴트 스토리지에 데이터쓰기 (find 명령으로 추가한 도큐먼트 확인)
3. 스토리지 클래스를 지정하지 않고 퍼시스턴트 볼륨 클레임 생성하기 (생성된 PVC 확인하기)


# 6 볼륨: 컨테이너에 디스크 스토리지 연결
 - 파드는 내부에 프로스ㅔ스가 실행되고 CPU, RAM 네트워크 인터페이스 등의 리소스를 공유하는 논리적 호스트와 유사
 - 프로세스가 디스크 공유 X
 - 파드 내부의 각 컨테이너는 고유한 파일시스템을 가짐, 파일시스템은 컨테이너 이미지에서 제공됨
 - 새로시작한 컨테이너는 이전에 실행했던 컨테이너에 씌여진 파일시스템의 어떤것도 볼수 x
 - 만약 실제 데이터를 가진 디렉터리를 보존하고 싶을 수 도있다. 쿠버에선 스토리지 볼륨을 정의 할 수 있다.
 - 스토리지 볼륨은 파드와 동일한 라이프 사이클을 가짐, 파드가 삭제되면 볼륨도 삭제됨.

#### 6.1 볼륨 소개
 - 볼륨은 파드스펙에서 정의된다.
 - 볼륨은 독립적 쿠버 OBJ가 아니므로 자체새성 삭제가 불가능
 - 각 컨테이너에서 파일시스템은 어느 경로에나 볼륨을 마운트할 수 있다.

#### 6.1.1 예제의 볼륨 설명
 - 리눅스에서 파일시스템을 파일 트리의 임의 경로에 마운트 할 수있다.
 - 이렇게 하면 마운트된 파일시스템의 내용은 마운트된 디렉터리에서 접근 가능하다.
 - 같은 볼륨을 두개의 컨테이너에 마운트하면 컨테이너는 동일한 파일로 동작 할 수 있다.
 - 책 경우에는 볼륨 두개를 컨테이너 세개에 마운트 한다.
 - 파드와 볼륨이 사라진 후에도 볼륨파일이 유지돼 새로운 볼륨으로 마운트 될 수 있다. 

#### 6.2.1. 사용 가능한 볼륨 유형 소개.
 - 볼륨 종류
     - emptyDir: 일시적인 데이터를 저장하는데 사용되는 간단한 빈 디렉터리
     - hostPath: 워커노드의 파일시스템을파드 디렉터리러 마운트 하는데 사용
     - gitRepo: 깃 레포지터리의 콘테츠를 체크아웃해 초기화한 볼륨이다.
     - nfs: NFS 공유를 파드에 마운트 한다.
     - gcePersistencDisk, awsElasticBlockStore,azureDisk 
 - 단일 파드는 동시에 여러 유형의 볼륨을 사용할 수 있으며, 각 컨테이너에 볼륨을 마운트하거나 마운트하지않을 수 있다.

#### 6.2 볼륨을 사용한 컨테이너 간 데이터 공유
#### 6.2.1. emptyDir 볼륨 사용
 - emptyDir 볼륨은 파일 파드에서 실행중인 컨테이너 간 파일을 공유할 때 유용하다.
 - 컨테이너의 파일시스템은 쓰기가 불가할 수도 있고, 마은트된 볼륨에 쓰는 것이 유일한 옵션일 수 있다.
```
docker build -t edgarsang/fortune .
docker images
docker push edgarsang/fortune
kubectl create -f fortune-pod.yaml
kubectl port-forward fortune 8080:80
```
 #### emptyDir 을 사용하기 위한 매체 지정하기
 - 볼륨으로 사용한 emptyDir은 파드를 호스팅 하는 워커노드의 실제 디스크에 생성되므로 노드 디스크가 어떤 유형인지에 따라 성능이 결정됐다.
 - 반면 쿠버에 emptyDir을 디스크가 아닌 메모리를 사용하는 tmpfs파일시스템으로 생성하도록 요청 할 수 있다.
 - 이 작업을 위해 다음과 같이 emptyDir의 medium을 memory로 지정한다.
 - emptyDir 볼륨은 가장 단순한 볼륨유형이지만, 다른유형들도 이 볼륨을 기반으로 한다.
 
#### 6.2.2 깃 리포지터리를 볼륨으로 사용하기
 - gitRepo  볼륨은 기본적으로 emptyDir 볼륨이며 파드가 시작되면 깃 리포지터리를 복제하고 특정 리비전을 체크아웃해 데이터로 채운다.
 - 

#### 사이드카 컨테이너 소개
 - 깃 동기화 프로세스가 Nginx 웹 서버와 동일 컨테이너에서 실행되면 안 되며, 두 번째 컨테이너인 사이드카 컨테이너에서 실행되어야한다.
 - 사이드 카 컨테이너는 파드의 주 컨테이너의 동작을 보완한다.
#### gitRepo 볼륨에 대한 정리 
 - 새 디렉터리를 생성하지 않고 대신 기존에 존재하는 외부 디렉터리를 파드의 컨테이너 파일시스템에 마운트 한다.
 - 볼륨의 콘텐츠는 파드인스턴스 여러개에서 살아남을 수 있다.

### 6.3 워커 노드 파일시스템의 파일접근
 - 보통 파드는 호스트노드 인식X 노드의 파일시스템에 접근하면 안됨
 - 특정 시스템 레벨의 파드(보통 데몬셋으로 관리되는 것을 기억)는 노드의 파일을 읽거나 파일시스템을 통해 노드 디바이스를 접근하기 위해 노드의 파일시스템을 사용해야한다.
 - 쿠버는 hostPath 볼륨으로 가능하게한다

#### 6.3.1. hostPath 볼륨 소개
 - hostPath 볼륨은 노드 파일시스템의 특정 파일이나 디렉터리 가르킴
 - 동일한 경로 가리키면 동일한 파일표시
 - hostPath는 파드가 삭제되어도 유지
 - DB의 데이터 디렉터리 저장위치로 생각 X, 파드는 어떤 노드의 스케쥴링 되느냐에 따라 이전 데이터를 볼수 없을수 있다.
 - 일반적인 파드에서 사용하는것은 좋은 생각이 아니다.

#### 6.3.2. hostPath 볼륨을 사용하는 시스템 파드 검사하기
 - hostPath를 사용하기위해 새로운 파드를 생성대신 이미 이볼륨유형을 사용하는 전역파드를 보자
 - 노드 시스템 파일에 읽기/쓰기를 하는 경우에만 hostPath 볼륨을 사용한다는 것을 기악하자, 여러파드에 걸쳐 데이터를 유지하기위해 사용말자

### 6.4 퍼시스턴트 스토리지 사용
 - 파드의 data를 유지하기 위한 목적으로 지금까지 본 volume은 사용불가 NAS에 저장되어야함

#### 6.4.2. 기반 퍼시스턴트 스토리지로 다른 유형의 볼륨 사용하기
 - 클라우드마다 퍼시스턴트 볼륨 스토리지를 다르게 사용하여 만들 수 있다.

#### NFS 볼륨 사용하기
 - nfs-server 에서는 특정 경로를 외부에서 마운트 할수 있도록 exports 경로를 지정한다


#### 다른 스토리지 기술 사용하기
 - 쿠버에서는 많은 종류의 스토리지 기술을 지원한다. 그러나 파드의 볼륨이 실제 기반 인프라스트럭처를 참조하는것은 쿠버가 추구하는 바가아니다
 - 실례로 NFS의 서버의 이름을 지정해야 한다는것은 뭔가가 잘못된 느낌이다.
 - 이렇게 디펜던시를 가질경우 다른클러스터에서는 파드정의를 사용할 수 없다.
 - 이런 방식으로 사용하는 것은 파드에 퍼시스턴트 스토리지를 연결하는 최적의 방법이 아니다.

### 6.5. 기반 스토리지 기술과 파드 분리
 - 지금까지는 네트워크 스토리지인프라스트럭처에 관한 지식을 파드개발자가 가져야했다.
 - 배포 개발자는 어떤종류의 스토리지 기술인지 알필요 없어야하고
 - 동일한 방식으로 파드를 실행하기위해 어떤 유형의 물리서버가 사용되는지 알 필요가 없어야 한다.
 
#### 6.5.1. 퍼시스턴트 볼륨과 퍼시스턴트 볼륨 클레임 소개
 - 인프라스트럭처의 세부사항 처리 필요 없이 새로운 리소스 두개가 도입되어다.
 - PV와 PVC이다.
 - 관리자는 NFS 익스포트 및 퍼시스턴트 볼륨을 관리하고 사용자는  PV를 바라보게 PVC 설정 후 PVC를 바라보는 파드 생성
 
#### 6.5.2. PV 생성
 - 퍼시스턴트 볼륨과 클러스터노드는 파드나 퍼시스턴트클레임과 달리 특정 네임스페이스에 속하지 않는다

#### 6.5.3. 퍼시스턴트 볼륨 클레임 생성을 통한 퍼시스턴트 볼륨 요청
 - 이제 관리자의 모자를 벗고 개발자의 모자를 써보자
 - PV를 직접 사용할순 없고 클레임을 먼저해야한다
 - 파드가 재스케줄링되도 동일한 PVC를 사용가능한 상태가 유지되기 원하므로 PVC를 생성하는것은 파드를 생성하는 것과 별개의 프로세스다.
 - 파드에서 이름으로 퍼시스턴트 볼륨 클레임을 참조한다.
```
kubectl create -f mongodb-pv-hostpath.yaml 
kubectl get pv
kubectl create -f mongodb-pvc-hostpath.yaml 
kubectl get pvc #will pedning pv
kubectl create -f mongodb-pod-pvc.yaml
kubectl exec -it mongodb mongo 
```
 - 이렇게되면 동일한 파드와 클레임 매니페스트는 어떤것도 참조안하므로 다른 쿠버에서도 쓸 수 있다.

#### 6.5.6 퍼시스턴트 볼륨재사용
 - 파드와 pvc를 삭제하고 다시 pvc를 생성해보자
```
kubectl delete po mongodb
kubectl delete pvc mongodb-pvc
```
 - pvc가 계속 펜딩중 일것이다.
 - pv를 살펴보면 이미 릴리즈드 되어있다. 이미 볼륨을 사용했기때문에 관리작가 볼륨을 비우지않으면 사용할수없다.

#### 퍼시스턴트 볼륨을 자동으로 다시 클레임하기
 - 리클레임 정책은 Retain, Recycle, Delete 이다
 - 리테인은 클레임이 해제되어도 볼륨과 콘텐츠 유지한다.
 - 리싸이클은 볼륨 콘텐츠삭제하고 다시 클레임 될수있도록 볼륨을 ㅏㅅ용가능하게 만든다
 - 델리트 정책ㄱ은 기반스토리지를 삭제한다.

